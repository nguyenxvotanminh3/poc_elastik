name: üöÄ Deploy AI Vector Search (Streamlit + FastAPI)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üöÄ Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: true
          timeout: 30m
          command_timeout: 30m
          script: |
            set -e
            
            echo "=============================================="
            echo "üöÄ DEPLOYING AI VECTOR SEARCH DEMO"
            echo "=============================================="
            
            # ============================================
            # CONFIGURATION
            # ============================================
            PROJECT_DIR="/srv/poc_elastik"
            REPO_BRANCH="main"
            
            source "$HOME/.bashrc" 2>/dev/null || true
            source "$HOME/.profile" 2>/dev/null || true
            source "$HOME/.nvm/nvm.sh" 2>/dev/null || true
            
            export PATH=$PATH:/usr/local/bin:/usr/bin:$HOME/.npm-global/bin:$HOME/.local/bin
            
            # ============================================
            # 1. CLONE/UPDATE CODE
            # ============================================
            echo ""
            echo ">>> [1/6] C·∫≠p nh·∫≠t source code..."
            
            if [ ! -d "$PROJECT_DIR" ]; then
              sudo mkdir -p "$PROJECT_DIR"
              sudo chown $USER:$USER "$PROJECT_DIR"
            fi
            
            cd "$PROJECT_DIR"
            
            if [ ! -d ".git" ]; then
              git clone git@github-poc:${{ github.repository }}.git .
            fi
            
            git fetch origin $REPO_BRANCH
            git reset --hard origin/$REPO_BRANCH
            echo "‚úÖ Code updated"
            
            # ============================================
            # 2. SETUP PYTHON
            # ============================================
            echo ""
            echo ">>> [2/6] C√†i ƒë·∫∑t th∆∞ vi·ªán Python..."
            
            PYTHON_CMD="python3"
            if ! command -v python3 &> /dev/null; then PYTHON_CMD="python"; fi
            
            if [ ! -d "venv" ]; then
              $PYTHON_CMD -m venv venv
            fi
            
            source venv/bin/activate
            pip install --upgrade pip -q
            pip install -r requirements.txt -q
            echo "‚úÖ Dependencies installed"
            
            # ============================================
            # 3. LOAD ENV & CHECK ELASTICSEARCH
            # ============================================
            echo ""
            echo ">>> [3/6] Load m√¥i tr∆∞·ªùng & Ki·ªÉm tra ES..."
            
            if [ -f ".env" ]; then
              echo "Loading .env file..."
              set -a
              source .env
              set +a
              echo "‚úÖ Loaded environment variables"
            else
              echo "‚ö†Ô∏è  WARNING: .env file not found. App might crash!"
            fi
            
            ES_HOST="${ES_HOST:-http://localhost:9200}"
            if curl -s "$ES_HOST" > /dev/null 2>&1; then
              echo "‚úÖ Elasticsearch is running at $ES_HOST"
            else
              echo "‚ö†Ô∏è  WARNING: Elasticsearch NOT responding at $ES_HOST"
            fi
            
            # ============================================
            # 4. SETUP SYSTEMD SERVICES
            # ============================================
            echo ""
            echo ">>> [4/6] C·∫•u h√¨nh systemd services..."
            
            # FastAPI Service
            cat << 'FASTAPI_EOF' | sed 's/^[[:space:]]*//' | sudo tee /etc/systemd/system/poc-fastapi.service > /dev/null
            [Unit]
            Description=POC FastAPI Backend
            After=network.target

            [Service]
            Type=simple
            WorkingDirectory=/srv/poc_elastik
            Environment=PATH=/srv/poc_elastik/venv/bin:/usr/local/bin:/usr/bin
            EnvironmentFile=/srv/poc_elastik/.env
            ExecStart=/srv/poc_elastik/venv/bin/python -m uvicorn main:app --host 0.0.0.0 --port 8000
            Restart=always
            RestartSec=3
            
            # Memory limits ƒë·ªÉ tr√°nh crash
            MemoryMax=2G
            MemoryHigh=1.5G

            [Install]
            WantedBy=multi-user.target
            FASTAPI_EOF
            
            # Streamlit Service
            cat << 'STREAMLIT_EOF' | sed 's/^[[:space:]]*//' | sudo tee /etc/systemd/system/poc-streamlit.service > /dev/null
            [Unit]
            Description=POC Streamlit Frontend
            After=network.target

            [Service]
            Type=simple
            WorkingDirectory=/srv/poc_elastik
            Environment=PATH=/srv/poc_elastik/venv/bin:/usr/local/bin:/usr/bin
            EnvironmentFile=/srv/poc_elastik/.env
            ExecStart=/srv/poc_elastik/venv/bin/python -m streamlit run streamlit_app.py --server.port 8501 --server.address 0.0.0.0 --server.headless true --browser.gatherUsageStats false
            Restart=always
            RestartSec=3
            
            # Memory limits
            MemoryMax=2G
            MemoryHigh=1.5G

            [Install]
            WantedBy=multi-user.target
            STREAMLIT_EOF
            
            # ============================================
            # 5. SETUP WATCHDOG SERVICE
            # ============================================
            echo ""
            echo ">>> [5/6] C√†i ƒë·∫∑t Watchdog monitoring..."
            
            # Make watchdog executable
            chmod +x "$PROJECT_DIR/watchdog.sh"
            
            # Create watchdog systemd service
            cat << 'WATCHDOG_EOF' | sed 's/^[[:space:]]*//' | sudo tee /etc/systemd/system/poc-watchdog.service > /dev/null
            [Unit]
            Description=POC Watchdog - Monitor and auto-restart services
            After=network.target poc-fastapi.service poc-streamlit.service
            Requires=poc-fastapi.service poc-streamlit.service

            [Service]
            Type=simple
            WorkingDirectory=/srv/poc_elastik
            ExecStart=/srv/poc_elastik/watchdog.sh
            Restart=always
            RestartSec=10
            
            # Run as current user
            User=$USER
            Group=$USER

            [Install]
            WantedBy=multi-user.target
            WATCHDOG_EOF
            
            echo "‚úÖ Systemd service files created"
            
            # ============================================
            # 6. RESTART ALL SERVICES
            # ============================================
            echo ""
            echo ">>> [6/6] Kh·ªüi ƒë·ªông l·∫°i services..."
            
            # Reload systemd
            sudo systemctl daemon-reload
            
            # Enable all services
            sudo systemctl enable poc-fastapi poc-streamlit poc-watchdog
            
            # Restart main services first
            sudo systemctl restart poc-fastapi
            sudo systemctl restart poc-streamlit
            
            # Wait for services to stabilize
            sleep 5
            
            # Start watchdog
            sudo systemctl restart poc-watchdog
            
            # Wait for watchdog to initialize
            sleep 3
            
            # ============================================
            # 7. VERIFICATION & FINISH
            # ============================================
            echo ""
            echo "=============================================="
            echo "‚úÖ DEPLOYMENT SUCCESSFUL!"
            echo "=============================================="
            echo ""
            echo "üìç Services Status:"
            echo ""
            echo "FastAPI:"
            sudo systemctl status poc-fastapi --no-pager -l || true
            echo ""
            echo "Streamlit:"
            sudo systemctl status poc-streamlit --no-pager -l || true
            echo ""
            echo "Watchdog:"
            sudo systemctl status poc-watchdog --no-pager -l || true
            echo ""
            echo "üìç URLs:"
            echo "   - FastAPI: http://YOUR_SERVER_IP:8000/docs"
            echo "   - Web App: http://YOUR_SERVER_IP:8501"
            echo ""
            echo "üìù Useful commands:"
            echo "   sudo systemctl status poc-fastapi"
            echo "   sudo systemctl status poc-streamlit"
            echo "   sudo systemctl status poc-watchdog"
            echo "   sudo journalctl -u poc-fastapi -f"
            echo "   sudo journalctl -u poc-streamlit -f"
            echo "   sudo journalctl -u poc-watchdog -f"
            echo "   tail -f /srv/poc_elastik/logs/watchdog.log"