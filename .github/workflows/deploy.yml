name: ðŸš€ Deploy AI Vector Search (Streamlit + FastAPI)

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Cho phÃ©p trigger thá»§ cÃ´ng

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸš€ Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: true
          timeout: 30m
          command_timeout: 30m
          script: |
            set -e
            
            echo "=============================================="
            echo "ðŸš€ DEPLOYING AI VECTOR SEARCH DEMO"
            echo "=============================================="
            
            # ============================================
            # CONFIGURATION
            # ============================================
            PROJECT_DIR="/srv/poc_elastik"
            REPO_BRANCH="main"
            
            # Load path cÆ¡ báº£n
            export PATH=$PATH:/usr/local/bin:/usr/bin
            
            # ============================================
            # 1. CLONE/UPDATE CODE
            # ============================================
            echo ""
            echo ">>> [1/5] Cáº­p nháº­t source code..."
            
            # Táº¡o thÆ° má»¥c náº¿u chÆ°a cÃ³
            if [ ! -d "$PROJECT_DIR" ]; then
              sudo mkdir -p "$PROJECT_DIR"
              sudo chown $USER:$USER "$PROJECT_DIR"
            fi
            
            cd "$PROJECT_DIR"
            
            # Clone code
            if [ ! -d ".git" ]; then
              git clone git@github-poc:${{ github.repository }}.git .
            fi
            
            # Pull code má»›i
            git fetch origin $REPO_BRANCH
            git reset --hard origin/$REPO_BRANCH
            echo "âœ… Code updated"
            
            # ============================================
            # 2. SETUP PYTHON
            # ============================================
            echo ""
            echo ">>> [2/5] CÃ i Ä‘áº·t thÆ° viá»‡n Python..."
            
            PYTHON_CMD="python3"
            if ! command -v python3 &> /dev/null; then PYTHON_CMD="python"; fi
            
            if [ ! -d "venv" ]; then
              $PYTHON_CMD -m venv venv
            fi
            
            source venv/bin/activate
            pip install --upgrade pip -q
            pip install -r requirements.txt -q
            echo "âœ… Dependencies installed"
            
            # ============================================
            # 3. LOAD ENV & CHECK ELASTICSEARCH
            # ============================================
            echo ""
            echo ">>> [3/5] Load mÃ´i trÆ°á»ng & Kiá»ƒm tra ES..."
            
            # --- PHáº¦N QUAN TRá»ŒNG: Load .env an toÃ n ---
            if [ -f ".env" ]; then
              echo "Loading .env file..."
              set -a  # Tá»± Ä‘á»™ng export cÃ¡c biáº¿n Ä‘Æ°á»£c load
              source .env
              set +a
              echo "âœ… Loaded environment variables"
            else
              echo "âš ï¸  WARNING: .env file not found. App might crash!"
            fi
            
            # Kiá»ƒm tra Elasticsearch
            ES_HOST="${ES_HOST:-http://localhost:9200}"
            if curl -s "$ES_HOST" > /dev/null 2>&1; then
              echo "âœ… Elasticsearch is running at $ES_HOST"
            else
              echo "âš ï¸  WARNING: Elasticsearch NOT responding at $ES_HOST"
            fi
            
            # ============================================
            # 4. RESTART SERVICES
            # ============================================
            echo ""
            echo ">>> [4/5] Khá»Ÿi Ä‘á»™ng láº¡i services..."
            
            # XÃ³a tiáº¿n trÃ¬nh cÅ©
            pm2 delete poc-fastapi 2>/dev/null || true
            pm2 delete poc-streamlit 2>/dev/null || true
            pkill -f "uvicorn main:app" 2>/dev/null || true
            pkill -f "streamlit run streamlit_app.py" 2>/dev/null || true
            
            # Khá»Ÿi Ä‘á»™ng láº¡i
            VENV_PYTHON="$PROJECT_DIR/venv/bin/python"
            
            # 1. FastAPI
            pm2 start $VENV_PYTHON \
              --name poc-fastapi \
              --cwd "$PROJECT_DIR" \
              -- -m uvicorn main:app --host 0.0.0.0 --port 8000
            
            # 2. Streamlit
            pm2 start $VENV_PYTHON \
              --name poc-streamlit \
              --cwd "$PROJECT_DIR" \
              -- -m streamlit run streamlit_app.py \
                --server.port 8501 \
                --server.address 0.0.0.0 \
                --server.headless true \
                --browser.gatherUsageStats false
            
            # ============================================
            # 5. FINISH
            # ============================================
            pm2 save
            echo ""
            echo "âœ… DEPLOYMENT SUCCESSFUL!"
            echo "Check URLs:"
            echo "- FastAPI: http://$Input_HOST:8000/docs"
            echo "- Web App: http://$Input_HOST:8501"